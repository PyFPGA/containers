FROM ubuntu:latest AS build

WORKDIR /root

RUN apt update -qq \
 && DEBIAN_FRONTEND=noninteractive apt install -y --no-install-recommends \
    # Common
    build-essential \
    ca-certificates \
    git \
    zlib1g-dev \
    # GHDL
    gnat \
    # Yosys
    clang \
    bison \
    flex \
    libreadline-dev \
    tcl-dev \
    libffi-dev \
    pkg-config \
    python3 \
 && apt autoclean && apt clean && apt -y autoremove \
 && rm -rf /var/lib/apt/lists/*

#
# GHDL
#

RUN git clone --depth 1 https://github.com/ghdl/ghdl \
 && mkdir ghdl/build && cd ghdl/build \
 && ../configure --prefix=/usr/local \
 && make -j$(nproc) && make install \
 && cd /root && rm -fr ghdl

#
# Yosys
#

RUN git clone --depth 1 https://github.com/YosysHQ/yosys \
 && cd yosys && git submodule update --init \
 && make -j$(nproc) && make install \
 && cd /root && rm -fr yosys

#
# ghdl-yosys-plugin
#

RUN git clone --depth 1 https://github.com/ghdl/ghdl-yosys-plugin.git \
 && cd ghdl-yosys-plugin && git submodule update --init \
 && make -j$(nproc) && make install \
 && cd /root && rm -fr ghdl-yosys-plugin
